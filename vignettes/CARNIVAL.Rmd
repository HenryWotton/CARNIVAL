---
title: "Contextualizing large scale signalling networks from expression footprints with CARNIVAL"
author: "Enio Gjerga, Matteo Spatuzzi"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{narray Usage Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, echo=FALSE, results='hide', warning=FALSE, error=FALSE, message=FALSE, cache=FALSE}
library(knitr)
opts_chunk$set(
  cache = FALSE,
  echo = TRUE,
  warning = FALSE,
  error = FALSE,
  message = FALSE
)
```

Introduction
============
While gene expression profiling is commonly used to gain an overview of cellular
processes, the identification of upstream processes that drive expression 
changes remains a challenge. To address this issue, we introduce 
CARNIVAL ([Liu, Trairatphisan, Gjerga et al 2019](https://www.nature.com/articles/s41540-019-0118-z)), 
a causal network contextualization tool which derives network architectures from
gene expression footprints. [CARNIVAL](https://saezlab.github.io/CARNIVAL/) 
(CAusal Reasoning pipeline for Network identification using Integer VALue 
programming) integrates different sources of prior knowledge including signed 
and directed protein-protein interactions, transcription factor targets, and 
pathway signatures.

Pipeline
--------
CARNIVAL refines a quantitative objective function for ILP problem by 
incorporating TF and pathway activities on a continuous scale. In addition, the 
CARNIVAL framework allows us to contextualize the network with or without known 
targets of perturbations. The implementation is separated into two pipelines 
which will be referred henceforth as Standard CARNIVAL StdCARNIVAL (with 
known perturbation targets as an input) and Inverse CARNIVAL InvCARNIVAL 
(without information on targets of perturbation). The differential gene 
expression is used to infer transcription factor (TF) activities with DoRothEA, 
which are subsequently discretized in order to formulate ILPconstraints. As a 
result, CARNIVAL derives a family of highest scoring networks which best explain
the inferred TF activities. Continuous pathway and TF activities can be 
additionally considered in the objective function.


![Figure 1: CARNIVAL  pipeline](./vignettes_pictures/graphical_abstract.png)

ILP solvers
-----------
CARNIVAL is an extension of the previously implemented Causal Reasoning 
method from [Melas et al.](https://pubs.rsc.org/en/content/articlelanding/2015/ib/c4ib00294f#!divAbstract).
The network inference process is swiftly performed with an Integer Linear 
Programming (ILP) formulation of causal reasoning using three solvers: the 
[R-CRAN lpSolve](https://cran.r-project.org/web/packages/lpSolve/index.html) 
free software used for solving linear problems; the open-source mixed integer 
programming solver [Cbc](https://projects.coin-or.org/Cbc) (Coin-or branch and 
cut); or the [CPLEX optimizer](https://www.ibm.com/analytics/cplex-optimizer) 
from IBM which can be obtained for free through the Academic Initiative. To 
perform the analysis with cplex or cbc, the users will then need to store the 
binary cbc or cplex executables on any  directory they wish. The binary files of
cbc can be found by first downloading one of the optimization suites
provided here: https://www.coin-or.org/download/binary/OptimizationSuite/,
unzip the download and from there save the cbc executable (which can be
found on the bin directory) file on any of the direcotries they wish of
their machines. As for the cplex, the executable file can be obtained
after registration on the [ILOG CPLEX Optimization Studio]({https://my15.digitalexperience.ibm.com/b73a5759-c6a6-4033-ab6b-d9d4f9a6d65b/dxsites/151914d1-03d2-48fe-97d9-d21166848e65/technology/data-science)
Similar like before, users will have to find the cplex executable binary 
file and save on a directory of their own wish or keep them on their default 
installation paths. The path to interactive version of CPLEX is differed 
based on the operating system. The default installation path for each OS is as 
follows:

For Mac OS:
```
    ~/Applications/IBM/ILOG/CPLEX_Studio129/cplex/bin/x86-64_osx/cplex
```

For Linux:
```
    /opt/ibm/ILOG/CPLEX_Studio129/cplex/bin/x86-64_linux/cplex
```

For Windows:
```
    C:/Program Files/IBM/ILOG/CPLEX_Studio129/cplex/bin/x64_win64/cplex.exe
```

Note that the version of CPLEX has to be changed accordingly (the latest
current version is CPLEX-Studio129).

The  lpSolve solver can be used after downloading and installing the
[lpSolve](https://cran.r-project.org/web/packages/lpSolve/index.html) R-package.
This solver only works for smaller examples and it can give only one optimal 
solution. For larger real-case examples, the users can use cbc or cplex solvers.

Prerequisites
-------------
Besides the above mentioned solvers, users need also to install the following 
R-package dependencies: [readr](https://cran.r-project.org/web/packages/readr/index.html);
[igraph](https://igraph.org/r/); [readxl](https://readxl.tidyverse.org/); 
[dplyr](https://www.rdocumentation.org/packages/dplyr/versions/0.7.8);
[lpSolve](https://cran.r-project.org/web/packages/lpSolve/index.html)

In order to visualize the automatically generated CARNIVAL networks, 
users will also need to download and install the Graph Visualization software 
[graphviz](https://www.graphviz.org/).

Running CARNIVAL
================
The CARNIVAL package provides the use with five functions to run the Carnival pipeline in a flexible way.
runVanillaCarnival is used to run the standard carnival pipeline with one function, while runInverseCarnival runs inverse Carnival (no input). The generateLPFileCarnival and runCarnivalFromLp  functions  work in tandem and allow the user for example to  obtain the LPFile without running the whole pipeline or create an LPFile from a different source and run the Carnival pipeline with it. These functions also contain multiple parameters to tailor the 

In the CARNIVAL package, built-in examples are available as the test cases as 
follows:

1. A small toy example where the inputs are known (stdCARNIVAL)

2. A small toy example where the inputs are not known (invCARNVAL)

3. A small toy example where the inputs are known run with two functions (stdCARNIVAL)


The Data of these toy examples looks as follows:

* Two input Nodes I1 and I2 connected to the nodes N1 and N2 respectively
* N1 and N2 are connected to both measured Nodes M1 and M2 
* All connections beside I2 to N2 are activatory

Toy Example - 1
---------------
Toy example for the CARNIVAL standard pipeline:

```{r}

load(file = system.file("toy_perturbations_ex1.RData",
                        package="CARNIVAL"))
load(file = system.file("toy_measurements_ex1.RData",
                        package="CARNIVAL"))
load(file = system.file("toy_network_ex1.RData",
                        package="CARNIVAL"))

carnivalOptions <- defaultCplexCarnivalOptions(solverPath = solverPath)

# Output dir
dir.create("example1", showWarnings = FALSE)

# lpSolve
resultsLpSolve <- runVanillaCarnival( perturbations = toy_perturbations_ex1, 
                                measurements = toy_measurements_ex1,
                                priorKnowledgeNetwork = toy_network_ex1, 
                                solver = supportedSolvers$lpSolve)

```
which generates the following output:
```{r}
print(resultsLpSolve)
```
The output from CARNIVAL can be saved in `Rds` format like so:
```{r}
saveRDS(resultsLpSolve, "example1/network_solution.Rds")
```

By changing the input for `outputFolder` element in carnivalOptions, the file 
`network_solution.dot` is saved in the specified directory. 
For example:
```{r}
carnivalOptions$outputFolder <- "example1"
result = runVanillaCarnival( perturbations = toy_perturbations_ex1, 
                             measurements = toy_measurements_ex1,
                             priorKnowledgeNetwork = toy_network_ex1, 
                             solver = supportedSolvers$lpSolve,
                             carnivalOptions = carnivalOptions)
```
which produces `network_solution.dot` file in the current working directory. 

This file, in turn, can be visualised using a software from 
[graphviz](https://graphviz.org) suite of tools. For example, using `dot`:
```{bash}
dot example1/network_solution.dot -T pdf > example1/network_solution.pdf
```
These options apply to all other pipelines of course as the results objects are structured in the same way.

```
#TODO remove quotes when fixing this
#![Network solution to toy example 1](example1/network_solution.pdf)
```

Toy Example - 2
---------------
Toy example for the CARNIVAL inverted pipeline:

```{r}
 # load CARNIVAL library

load(file = system.file("toy_measurements_ex2.RData",
                        package="CARNIVAL"))
load(file = system.file("toy_network_ex2.RData",
                        package="CARNIVAL"))

carnivalOptions <- defaultCplexCarnivalOptions(solverPath = solverPath)

# Output dir
dir.create("example2", showWarnings = FALSE)
carnivalOptions$outputFolder <- "example2"

# lpSolve

result = inverse_Out <-runInverseCarnival(measurements = toy_measurements_ex2, 
                                 priorKnowledgeNetwork = toy_network_ex2, 
                                 solver = supportedSolvers$cplex,
                                 solverPath = solverPath,
                                 carnivalOptions = carnivalOptions)
```
which generates the following output:
```{r}
print(result)

```
```
#TODO remove the quotes when fixing vignette
#![Network solution to toy example 2](example2/network_solution.pdf)
```

Toy Example - 3
---------------
Toy example for the CARNIVAL standard pipeline with generateLPFileCarnival and runCarnivalFromLp :

```{r}


load(file = system.file("toy_perturbations_ex1.RData",
                        package="CARNIVAL"))
load(file = system.file("toy_measurements_ex1.RData",
                        package="CARNIVAL"))
load(file = system.file("toy_network_ex1.RData",
                        package="CARNIVAL"))

carnivalOptions <- defaultCplexCarnivalOptions(solverPath = solverPath)

# Output dir
dir.create("example3", showWarnings = FALSE)
carnivalOptions$outputFolder <- "example3"

# lpSolve
generateLpFileCarnival(perturbations = toy_perturbations_ex1,
                                measurements = toy_measurements_ex1, 
                                priorKnowledgeNetwork = toy_network_ex1, 
                                solver = supportedSolvers$cplex,
                                solverPath = solverPath,
                                carnivalOptions = carnivalOptions)

```
which writes two files, an Lp File and a parsed Data file. The next function takes these files as inputs and runs the stdCARNIVAL Pipeline with them. 
```{r}

resultsFromLp <- runCarnivalFromLp(lpFile = "toy_files_vignettes/lpFile_t18_01_53d28_04_2021n4.lp",
                              parsedDataFile = "toy_files_vignettes/parsedData_t18_01_53d28_04_2021n4.RData",
                              solver = supportedSolvers$lpSolve,
                              solverPath = "",
                              carnivalOptions =
                              defaultLpSolveCarnivalOptions())
```
which generates the following output:

```{r}

resultsFromLp
```

```
#TODO remove the quotes when fixing vignette
#![Network solution to toy example 2](example2/network_solution.pdf)
```
